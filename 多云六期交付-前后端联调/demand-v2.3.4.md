# 多云需求文档 (V2.3.4)

## 版本

| 多云版本号 | 开始时间  | 截止时间  | 参与人员 | Mesh Server 版本 |
| :--------: | :-------: | :-------: | :------: | :--------------: |
|   v2.3.4   | 2021.7.19 | 2021.7.27 |   张纯   |      v2.3.4      |

## 需求

### 需求变更

- v2.3.4 api文档更新
- v2.3.4 原型更新
- v2.3.4 UED出图
- v2.3.4 数据库设计更新
- v2.3.4 后端代码实现
  - v2.3.4 多云集群联通性测试
  - v2.3.4  多云卸载逻辑
- incluster模式
- k8s权限配置调研文档

### 功能需求

- 可以选择接管已存在集群，不提供k8s基础层（infrastructure）安装。

- 提供灵活的证书管理功能

  - 用户自定义证书
  - 由本系统（HSMESH）提供证书

- 保证集群（节点）间通信正常

  > v2.3.1版本调研结果来看，主从模式下，从集群无法向主集群主动发起请求（不同clusterDomain）
  
- 服务管理新建服务时，可以选择已经接管的集群进行服务部署。

### 版本需求

文档输出+后端代码+原型设计

### 关联需求

服务管理功能在选择部署服务时，可以选择当前已接管的集群进行部署

### 前置条件

- 所有行为均基于拥有k8s基础层的前提下

### 环境&版本支持

- 系统环境：

  ```txt
  centos 7.3 - centos 7.6 支持
  
  推荐4核8线程 8G内存 及以上
  最低配置 2核4线程 4G内存
  
  硬盘存储 50G+
  
  所有宿主机网络互通
  ```

- 版本支持：

  ```
  k8s 1.18.2+
  docekr 19.03+
  istio 1.9.2
  ```



### 证书管理

- 增加：
  - 用户可以在本页面直接上传自己的根证书，在接管集群的时候可以选择使用根证书；
  - 用户可以选择使用hsmesh生成的根证书；
  - 支持用户自定义证书名；
- 删除：
  - 用户可以删除选择的证书（可多选）；
  - 已经被使用的证书不可以被删除；

- 查询：
  - 支持模糊查询；



### 接管

#### hsmesh自动接管集群

> v2.3.2 + : 用户可以接管集群，Mesh Server判断接管的集群是否已经安装了istio 

用户需要给hsmesh提供需要添加集群的kubeconfig文件，可以选择自动获取或者在页面中上传，自动获取需要获取对应集群master节点的root账户密码。

多云安装需要重新安装istio并重新选择根证书（默认使用istio生成的根证书）

首先判断接管机群是否已经安装了istio：

- 接管全新集群：
  1. 自动为用户k8s集群安装istio（默认1.9.2）；
  2. 根据用户选项安装多云环境（选项包括：多云部署模型；是否指定根证书；选择网卡类型（默认calico，目前只支持calico）；等）；
  3. 预测试（测试基础网络连通性；服务连通性；运行一些可以证明安装成功的测试用例，并以日志的形式输出，用于排查）；
  4. 提供手动测试入口；
  5. 提示用户存在一些注意事项：同一个mesh中，各个workload instance之间可以相互通信；svcname和namespace绑定，且同一个mesh中唯一；等。
- 移除：
  1. 用户点击移除，卸载istio，并清空根证书等信息；
  2. 用户移除集群，并不会删除根证书列表中的根证书，只会删除指定集群中的证书文件；

- 接管已安装istio集群
  1. 移除原有istio；
  2. 接管全新集群。